<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP8266 Status</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    
    <h1>ESP8266 Sensor Status</h1>
    
    <p id="last-message-from">Waiting for first message...</p>
    
    <p id="last-distance">Distance: --</p>
    
    <div id="status-square"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        const socket = io();
        
        // Get the HTML elements we need to control
        const square = document.getElementById('status-square');
        const statusText = document.getElementById('last-message-from');
        // --- *** NEW LINE *** ---
        const distanceText = document.getElementById('last-distance');

        socket.on('connect', () => {
            console.log('Successfully connected to server WebSocket.');
        });

        // --- *** MODIFIED SECTION *** ---
        // Listen for the 'new_message' event
        socket.on('new_message', (data) => {
            // 'data' is the full JSON object:
            // { ..., chipId: ..., distance: ... }
            
            console.log('Message received:', data);
            
            // 1. Update the status text with the Chip ID
            statusText.textContent = `Last message from: Board ${data.chipId}`;

            // 2. Update the distance text
            //    We check if the distance is a valid reading (not 0)
            if (data.distance > 0) {
                distanceText.textContent = `Distance: ${data.distance} cm`;
            } else {
                distanceText.textContent = "Distance: Out of range";
            }

            // 3. Run the flash-and-fade animation
            square.style.transition = 'none';
            square.style.backgroundColor = '#00ff00'; // Bright Green

            setTimeout(() => {
                square.style.transition = 'background-color 3s ease';
                square.style.backgroundColor = '#8b0000'; // Dark Red
            }, 100); 
        });
        // --- *** END OF MODIFICATION *** ---

        socket.on('disconnect', () => {
            console.log('Disconnected from server WebSocket.');
        });
    </script>
</body>
</html>